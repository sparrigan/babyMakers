{% extends 'd3_base.html' %}
{% block body %}

<script>

// TODO: Write some D3 around this, showing the flow of the program for blog

// List for collecting promises to use Promise.all
var finish_list = []
// Make the fourth queue promise wait longest
var wait_times = [0,0,0,0,10000];
// Resolved promise used to start queue
var sequence = Promise.resolve();

// Test promise - these run in parallel before
// entering the queue at randome times
function test_promise(idx) {
	return new Promise(function(resolve, reject) {
		// Resolve the promise after a random wait
		// (don't actually use the passed 'value')
		value = Math.random()*10;
		time = Math.random()*8000;
		setTimeout(function(){resolve([value, idx])}, time);
	});
}

// Queue promise - these promises are generated by the above test promises
// when they complete, & are sequentially chained off each other as a queue
function queue_promise(response) {
	return new Promise(function(resolve, reject) {
		// Resolve promise after a wait that depends on the promise id
		setTimeout(function() {resolve(response)}, wait_times[response]);

	});
}


// Generate five promises
for (i of [0,1,2,3,4]) {
	// Create new initial promise, passing its id.
	new_prom = test_promise(i).then(function(response){
		// When initial promise completed, write to console...
		console.log('Promise done. Idx: ', response[1]);
		//... and now add an associated promise (passed same id) to the queue
		sequence = sequence.then(function() {
			return queue_promise(response[1]);
		}).then(function(response) {
				// When promise reaches front of queue and is resolved, then afterwards
				// write to screen using its id
				console.log('FINAL PROMISE DONE. Idx: ', response);
		})
	});
	// Collect first (test) promises into a list for Promise.all
	finish_list.push(new_prom);
}

// Act whenn all initial (test) promises have resolved and thus added to queue
Promise.all(finish_list).then(function(value) {
	//Now queue is full, add another then which will resolve last in the queue
	//which can trigger following actions
	sequence = sequence.then(function() {
		console.log('ALL DONE!!!!');
	});
});

</script>


{% endblock %}
